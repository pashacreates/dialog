dialogs = [{
    avatar: 'img/fil.png',
    dialogName: 'Филипп',
    messages: [{
        date: new Date(2011, 04, 12, 15, 1, 55),
        name: 'You',
        text: 'У чувака пошла кровь из носа и он просит тридцатку?'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 0),
        name: 'Филипп',
        text: 'Скажите, Дрисс, как вы думаете, почему людей тянет к искусству?'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 05),
        name: 'You',
        text: 'Может, потому что это прибыльно?'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 10),
        name: 'Филипп',
        text: 'Нет, это единственный способ оставить след на земле.'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 12),
        name: 'You',
        text: 'Фигня это, Филипп! Я сейчас куплю красок на полтинник и наслежу на полную катушку. Ещё синий добавлю бесплатно.'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 15),
        name: 'Филипп',
        text: 'Так, хватит болтать чепуху. Дайте конфету.'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 18),
        name: 'You',
        text: 'Не-а'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 20),
        name: 'Филипп',
        text: 'Дайте мне конфету.'
    }, {
        date: new Date(2011, 04, 12, 15, 2, 23),
        name: 'You',
        text: 'Нету ручек - нет конфетки!'
    }]
}, {
    avatar: 'img/vin.png',
    dialogName: 'Винсент',
    messages: [{
        date: new Date(1994, 09, 14, 12, 3, 11),
        name: 'Винсент',
        text: ' А знаешь, как в Париже называют четвертьфунтовый чизбургер?'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'You',
        text: ' Что, они не зовут его четвертьфунтовый чизбургер?'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'Винсент',
        text: 'У них там метрическая система. Они вообще там не понимают, что за хрен четверть фунта.'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'You',
        text: 'И как они его зовут?'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'Винсент',
        text: 'Они зовут его «Роял чизбургер».'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'You',
        text: '«Роял чизбургер»? А как же тогда они зовут «Биг Мак»?',
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'Винсент',
        text: '«Биг Мак» это «Биг Мак», только они называют его «Лё Биг Мак».',
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'Винсент',
        text: 'А знаешь что они там в Голландии льют на картошку фри вместо кетчупа?',
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'You',
        text: 'Что?'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'Винсент',
        text: 'Майонез!'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'You',
        text: 'Черт подери!'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'Винсент',
        text: 'Я сам видел, как они это делают. Просто заливают все этим дерьмом.'
    }, {
        date: new Date(1994, 09, 14, 12, 3, 45),
        name: 'You',
        text: 'Гамбургеры! Краеугольный камень здорового питания.'
    }]
}, {
    avatar: 'img/vito.png',
    dialogName: 'Вито Корлеоне',
    messages: [{
        date: new Date(1972, 03, 14, 13, 5, 55),
        name: 'Вито Корлеоне',
        text: 'Я знаю тебя много лет, но ты никогда не обращался ко мне за советом или помощью. Я не могу вспомнить, когда ты в последний раз приглашал меня в свой дом на чашку кофе, хотя моя жена — крёстная твоего единственного ребёнка. Будем сейчас откровенны: ты никогда не искал моей дружбы и ты боялся быть у меня в долгу.'
    }, {
        date: new Date(1972, 03, 14, 13, 6, 0),
        name: 'You',
        text: ' Я не хотел нажить неприятностей.'
    }, {
        date: new Date(1972, 03, 14, 13, 6, 5),
        name: 'Вито Корлеоне',
        text: 'Я понимаю. Ты нашёл в Америке рай: у тебя хорошо шёл бизнес, тебя защищала полиция и тебе не нужны были такие друзья, как я. А теперь ты приходишь и говоришь: Дон Корлеоне, мне нужна справедливость. Но ты не просишь с уважением, не предлагаешь дружбу, даже не думаешь обратиться ко мне — крёстный. Нет, ты приходишь ко мне в дом в день свадьбы моей дочери и просишь убивать за деньги.'
    }]
}, {
    avatar: 'img/merlin.png',
    dialogName: 'Мэрлин',
    messages: [{
        date: new Date(2000, 02, 12, 22, 1, 55),
        name: 'You',
        text: 'А как переводится «How are you»?'
    }, {
        date: new Date(2000, 02, 12, 22, 2, 0),
        name: 'Мэрлин',
        text: '«Как дела или как поживаешь».'
    }, {
        date: new Date(2000, 02, 12, 22, 2, 04),
        name: 'You',
        text: 'И что, всем интересно, как у меня дела?'
    }, {
        date: new Date(2000, 02, 12, 22, 2, 8),
        name: 'Мэрлин',
        text: 'Не-а, неинтересно.'
    }, {
        date: new Date(2000, 02, 12, 22, 2, 13),
        name: 'You',
        text: 'А чего тогда спрашивают?'
    }, {
        date: new Date(2000, 02, 12, 22, 2, 18),
        name: 'Мэрлин',
        text: 'Просто так. Здесь вообще всё просто так, кроме денег.'
    }]
}, {
    avatar: 'img/косой.png',
    dialogName: 'Косой',
    messages: [{
        date: new Date(1971, 12, 13, 12, 1, 55),
        name: 'You',
        text: 'Сидит?'
    }, {
        date: new Date(1971, 12, 13, 12, 2, 01),
        name: 'Косой',
        text: 'Кто?'
    }, {
        date: new Date(1971, 12, 13, 12, 2, 12),
        name: 'You',
        text: 'Ну, мужик этот твой!'
    }, {
        date: new Date(1971, 12, 13, 12, 2, 23),
        name: 'Косой',
        text: 'Хе-хе-хе! Во деревня, а! Ну ты даешь! Кто же его посадит? Он же памятник!'
    }]
}, {
    avatar: 'img/ava-2.png',
    dialogName: 'John',
    messages: []
}, {
    avatar: 'img/ava-3.png',
    dialogName: 'Marry',
    messages: []
}]

const dialogsList = document.getElementById('dialogsList');
const dialog = document.getElementById('dialog');
const search = document.getElementById('search');

function searchMessage() {
    let val = this.value.trim().toLowerCase();

    if (val != '') {
        for (let i = 0; i < dialogs.length; i++) {
            //этим циклом из списка диалогов прячем диалоги не соответствующие критерию поиска
            if (dialogs[i].messages.length == 0) { dialogs[i].display = 'hidden'; }
            for (let j = 0; j < dialogs[i].messages.length; j++) {

                if (dialogs[i].messages[j].text.toLowerCase().search(val) == -1) {
                    dialogs[i].display = 'hidden';
                } else {
                    dialogs[i].display = 'display';
                    break;
                }
            };
            //пришлось сделать отдельный цикл без break
            //для перезаписи последнего сообщения в списке диалогов
            for (let j = 0; j < dialogs[i].messages.length; j++) {
                if (dialogs[i].messages[j].text.toLowerCase().search(val) == -1) {
                    dialogs[i].messages[j].mark = 0;
                } else {
                    dialogs[i].messages[j].mark = 1;
                }
            }
        }
    } else {

        dialogs.forEach(function(elem) {
            if (elem.messages.length == 0) {
                elem.display = 'display';
            }
            elem.messages.forEach(function(m) {
                elem.display = 'display';
                m.mark = 0;
            })
        });
    }
    renderDialogsList();
    dialog.innerText = '';
}

search.addEventListener('input', searchMessage);


function renderDialog(dialogsItem) {
    dialog.innerText = '';
    dialogsItem.messages.forEach(item => {
        let message = 'not-my';
        let ava = dialogsItem.avatar;
        if (item.name === 'You') {
            message = 'my';
            ava = 'img/userAva.png';
        };
        if (item.mark == 1) { message += ' mark' };
        dialog.insertAdjacentHTML('beforeend', `
            <li class='${message}'>
                <img src='${ava}'>
                <div>
                    <p>${item.name}:</p>
                    <p>${item.text}</p>
                    <i>${item.date.toLocaleDateString()}</i>
                </div>
            </li>`);

        if (dialog.querySelector('.mark') == null) {
            dialog.lastChild.scrollIntoView({ block: "end" });
        } else {
            const lastMesMark = dialog.getElementsByClassName('mark').length - 1;
            dialog.getElementsByClassName('mark')[lastMesMark].scrollIntoView({ block: "end", behavior: "smooth" });
        }
    });

    const sendForm = document.getElementById('sendForm');
    sendForm.innerText = '';
    sendForm.insertAdjacentHTML('beforeend', `
                <form>
                    <div class="input-text" id='inputText' contenteditable="true"></div>
                    <input type='button' value='SEND' class='send-but' id='sendBut'>
                </form>`);
    const sendBut = document.getElementById('sendBut');
    const inputText = document.getElementById('inputText');

    sendBut.addEventListener('click', function() {
        sendMessage(dialogsItem)
    });
    inputText.addEventListener('keydown', function() {
        if (event.keyCode == 13) {
            sendMessage(dialogsItem);
        }
    });
};

const sendMessage = function(a) {
    if (inputText.innerText !== "") {
        a.messages.push({
            date: new Date(),
            name: 'You',
            text: inputText.innerText
        })
        renderDialog(a);
        renderDialogsList();
    }
};

function renderDialogsList() {

    dialogs.sort(function(a, b) {
        if (a.messages.slice().pop() == undefined) {
            return;
        } else {
            return b.messages.slice().pop().date - a.messages.slice().pop().date;
        }
    });
    dialogsList.innerText = '';

    let lastMessage = {};

    dialogs.forEach((item, index) => {
        lastMessage = item.messages.slice().pop();
        for (let i = 0; i < item.messages.length; i++) {
            if (item.messages[i].mark == 1) {
                lastMessage = item.messages[i];
            }
        }
        if (lastMessage == undefined) {
            dialogsList.insertAdjacentHTML('beforeend', `
            <li class='my-dialogs-list-item' id=dialod#${index}>
                <figure>
                    <figcaption>${item.dialogName}</figcaption>
                    <img alt="ava" src='${item.avatar}' class='my-dialogs-ava'>
                </figure>
                <div class='my-dialogs-info'>
                    <p>Сообщений нет</p>
                </div>
            </li>`);
        } else {
            dialogsList.insertAdjacentHTML('beforeend', `
        <li class='my-dialogs-list-item' id=dialod#${index}>
            <figure>
                <figcaption>${item.dialogName}</figcaption>
                <img alt="ava" src='${item.avatar}' class='my-dialogs-ava'>
            </figure>
            <div class='my-dialogs-info'>
                <span>${lastMessage.date.toLocaleString()}</span>
                <p>${lastMessage.name}:<br/> ${(lastMessage.text.length<35) ? lastMessage.text : lastMessage.text.substr(0,35)+'...'}</p>
            </div>
        </li>`);
        }

        const d = document.getElementById(`dialod#${index}`);
        d.addEventListener('click', function() { renderDialog(item); });

        if (item.display == 'hidden') {
            d.classList.add('hidden');
        }


    })
};

renderDialogsList();